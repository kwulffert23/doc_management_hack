# Databricks notebook source
# MAGIC %md
# MAGIC # Driver notebook
# MAGIC
# MAGIC This is an auto-generated notebook created by an AI Playground export. We generated three notebooks in the same folder:
# MAGIC - [agent]($./agent): contains the code to build the agent.
# MAGIC - [config.yml]($./config.yml): contains the configurations.
# MAGIC - [**driver**]($./driver): logs, evaluate, registers, and deploys the agent.
# MAGIC
# MAGIC This notebook uses Mosaic AI Agent Framework ([AWS](https://docs.databricks.com/en/generative-ai/retrieval-augmented-generation.html) | [Azure](https://learn.microsoft.com/en-us/azure/databricks/generative-ai/retrieval-augmented-generation)) to deploy the agent defined in the [agent]($./agent) notebook. The notebook does the following:
# MAGIC 1. Logs the agent to MLflow
# MAGIC 2. Registers the agent to Unity Catalog
# MAGIC 3. Deploys the agent to a Model Serving endpoint
# MAGIC
# MAGIC ## Prerequisites
# MAGIC
# MAGIC - Address all `TODO`s in this notebook.
# MAGIC - Review the contents of [config.yml]($./config.yml) as it defines the tools available to your agent and the LLM endpoint.
# MAGIC - Review and run the [agent]($./agent) notebook in this folder to view the agent's code, iterate on the code, and test outputs.
# MAGIC
# MAGIC ## Next steps
# MAGIC
# MAGIC After your agent is deployed, you can chat with it in AI playground to perform additional checks, share it with SMEs in your organization for feedback, or embed it in a production application. See docs ([AWS](https://docs.databricks.com/en/generative-ai/deploy-agent.html) | [Azure](https://learn.microsoft.com/en-us/azure/databricks/generative-ai/deploy-agent)) for details

# COMMAND ----------

# MAGIC %pip install -U -qqqq mlflow databricks-agents
# MAGIC dbutils.library.restartPython()

# COMMAND ----------

catalog_name = "kyra_wulffert"
schema_name = "poc_doc_management"
volume_name = "docs"
raw_table_name = "raw_docs"
VS_INDEX = "db_doc_poc_doc_management_sequential"

# COMMAND ----------

# MAGIC %md
# MAGIC ### Log the `agent` as an MLflow model
# MAGIC Log the agent as code from the [agent]($./agent) notebook. See [MLflow - Models from Code](https://mlflow.org/docs/latest/models.html#models-from-code).

# COMMAND ----------

# Log the model to MLflow
import os
import mlflow

from mlflow.models import ModelConfig
from mlflow.models.signature import ModelSignature
from mlflow.models.rag_signatures import (
    ChatCompletionRequest,
    ChatCompletionResponse,
)
from mlflow.models.resources import DatabricksFunction, DatabricksServingEndpoint, DatabricksVectorSearchIndex
from databricks.sdk import WorkspaceClient

w = WorkspaceClient()
config = ModelConfig(development_config="config.yml")
resources = [
        DatabricksServingEndpoint(endpoint_name=config.
                                  get("llm_endpoint")),
        DatabricksVectorSearchIndex(index_name=config.
                                    get("vector_search_index")),
        ]
uc_functions_to_expand = config.get("tools").get("uc_functions")
for func in uc_functions_to_expand:
    # if the function name is a regex, get all functions in the schema
    if func.endswith("*"):
        catalog, schema, _ = func.split(".")
        expanded_functions = list(
            w.functions.list(catalog_name=catalog, schema_name=schema)
        )
        for expanded_function in expanded_functions:
            resources.append(
                DatabricksFunction(function_name=expanded_function.full_name)
            )
    # otherwise just add the function
    else:
        resources.append(DatabricksFunction(function_name=func))

signature = ModelSignature(ChatCompletionRequest(), ChatCompletionResponse())

input_example = {
    "messages": [{"role": "user", "content": "What is DSO?"}]
}

with mlflow.start_run():
    logged_agent_info = mlflow.pyfunc.log_model(
        "agent",
        python_model=os.path.join(
            os.getcwd(),
            "agent",
        ),
        signature=signature,
        input_example=input_example,
        model_config="config.yml",
        resources=resources,
    )

# COMMAND ----------

# MAGIC %md
# MAGIC ## Evaluate the agent with [Agent Evaluation](https://docs.databricks.com/generative-ai/agent-evaluation/index.html)
# MAGIC
# MAGIC You can edit the requests or expected responses in your evaluation dataset and run evaluation as you iterate your agent, leveraging mlflow to track the computed quality metrics.

# COMMAND ----------

docs_df = (
    spark.table(f"{catalog_name}.{schema_name}.{raw_table_name}")
    .withColumnRenamed("text", "content")
    .withColumnRenamed("file_name", "doc_uri")
    
)
display(docs_df)

# COMMAND ----------

# Optional guideline
guidelines = """
You are a generator tasked with creating an evaluation dataset for a Q&A chatbot that uses a Retrieval-Augmented Generation (RAG) solution. The chatbot is designed to provide accurate, concise, and relevant answers based on given documents in the knowledge base of the RAG solution.

### Task Description:
Your job is to generate realistic, varied, and challenging question-answer pairs that will be used to test the chatbot's performance. Each question must be crafted with the following guidelines:
1. Questions should reflect the information needs of professionals working at energy supplier companies, including operations managers, regulatory affairs specialists, and technical engineers.
2. Answers should be relevant to the given documents and not include hallucinated or invented information.
3. Include a clear reference to the source document or section from which the answer is derived (e.g., "Source: RIIO-ED2 Final Determinations Document, Chapter 3, Page 12").

### Content Guidance:
1. Questions should span the following categories:
   - Regulatory policies and compliance.
   - Financial incentives and penalties.
   - Distribution network operations and infrastructure.
   - Consumer impact assessments.
   - Sustainability and net-zero goals.

2. Ensure the dataset contains a mix of:
   - Direct factual questions (e.g., "What are the financial incentives for exceeding sustainability goals?").
   - Interpretive questions (e.g., "How does the RIIO-ED2 framework address consumer benefits?").
   - Context-specific scenarios (e.g., "As an energy supplier, how should we respond to changes in incentive structures outlined in the RIIO-ED2?").

### Style Guidelines:
1. Answers should be concise but detailed enough to be actionable for professionals.
2. Use formal and professional language.
3. Avoid jargon unless necessary, and define technical terms when used.

### Personas:
1. **Regulatory Affairs Specialist**:
   - Focus on compliance requirements, policies, and implications of determinations.
   - Example question: "What penalties are outlined for non-compliance with the RIIO-ED2 determinations?"

2. **Operations Manager**:
   - Interested in operational impact and infrastructure-related incentives.
   - Example question: "What incentives are available for modernizing distribution networks?"

3. **Technical Engineer**:
   - Seeks technical details on energy infrastructure and implementation.
   - Example question: "What are the technical specifications for achieving net-zero goals in distribution networks?"

4. **Consumer Advocacy Lead**:
   - Concerned with consumer impact and benefits.
   - Example question: "How does the RIIO-ED2 framework ensure consumer affordability?"

### Example Question-Answer Pairs:
1. **Question**: "What are the financial incentives for DNOs to improve stakeholder engagement?"
   **Answer**: "The RIIO-ED2 framework includes stakeholder satisfaction surveys as part of the performance assessment, rewarding DNOs with financial incentives for high engagement scores. Source: RIIO-ED2 Final Determinations Document, Chapter 4, Page 18."

2. **Question**: "What are the penalties for failing to meet net-zero targets?"
   **Answer**: "DNOs failing to meet net-zero targets may face reduced allowances and potential regulatory action. Source: RIIO-ED2 Final Determinations Document, Chapter 7, Page 42."

3. **Question**: "What are the requirements for DNOs under the RIIO-ED2 to improve infrastructure resilience?"
   **Answer**: "DNOs are required to implement advanced distribution management systems and reinforce network infrastructure to ensure resilience. Source: RIIO-ED2 Final Determinations Document, Chapter 5, Page 30."

Generate a diverse set of such question-answer pairs, ensuring they align with the personas, categories, and guidelines provided. Include the reference for each answer and ensure factual alignment with the source material.
"""

# COMMAND ----------

from pyspark.sql.functions import col, to_json, struct, expr, lit
from databricks.agents.evals import generate_evals_df

# Convert the list to a Spark DataFrame
docs_sample_df = spark.createDataFrame(docs_df.head(20))

# Generate 1 question for each document
synthetic_eval_data = generate_evals_df(
    docs=docs_sample_df,
    guidelines=guidelines, 
    num_evals=20
)

display(synthetic_eval_data)

# COMMAND ----------

# import pandas as pd

# eval_examples = [
#     {
#         "request": {
#             "messages": [
#                 {
#                     "role": "system",
#                     "content": "You are a highly knowledgeable assistant specializing in answering questions about energy regulation and policies. You have access to a knowledge base of official documents. Your goal is to provide accurate, concise, and helpful answers based strictly on the information in these documents. You must not hallucinate or invent any information. If the answer cannot be found in the documents, politely inform the user. If you do not know the answer to a question, you truthfully say you do not know.\n\nWhen the user asks a question, follow these steps:\n\n1. **Check for Acronyms**:\n   - If the user's input contains an acronym (e.g., CBA, LAEP):\n     - Use the **glossary_lookup** tool to fetch the definition of the acronym from the glossary.\n     - After retrieving the definition, ask the user: \"Is '{definition}' what you meant by {acronym}? (Yes/No)\".\n       - The definition should be **explicitly provided** in the confirmation question. For example: \"Is 'Cost-Benefit Analysis' what you meant by CBA? (Yes/No)\".\n     - If the user confirms with \"Yes\":\n       - Proceed by using the **vector search** function to retrieve relevant context from the RAG system, **enhancing the context with the acronym's definition**.\n       - Craft your answer based on the retrieved context and the acronym's definition, ensuring that you include the **file name** and other relevant metadata in the response.\n     - If the user does **not** confirm the definition with \"Yes\":\n       - Politely ask the user for more clarification by saying: \"Could you please provide more context or clarify what you mean by {acronym}?\" and do **not** proceed to context retrieval until you receive further clarification.\n\n2. **If No Acronym is Present**:\n   - If the user's input **does not contain an acronym**, proceed directly to **vector search** to retrieve the relevant context based on the question.\n   - Craft your answer based on the retrieved context, ensuring you include the **file name** and other relevant metadata.\n\n3. **Contextual Answering**:\n   - After the acronym is validated (or if no acronym is present), use the retrieved context from the vector search to answer the question directly.\n   - Include the **file_name** (or any other relevant metadata) from the context to show where the information was retrieved from, for example, \"The information was retrieved from the document: {file_name}\".\n   - Do not include any unnecessary explanations about the context or the process.\n\nHere is the history of the current conversation you are having with your user: {chat_history}. And here is some context which may or may not help you answer the following question: {context}. Answer directly, do not repeat the question, do not start with something like: \"the answer to the question\", do not add \"AI\" in front of your answer, do not say: \"here is the answer\", do not mention the context or the question. Based on this context, answer this question: {question}.\n"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Hi"
#                 }
#             ]
#         },
#         "expected_response": None
#     },
#     {
#         "request": {
#             "messages": [
#                 {
#                     "role": "system",
#                     "content": "You are a highly knowledgeable assistant specializing in answering questions about energy regulation and policies. You have access to a knowledge base of official documents. Your goal is to provide accurate, concise, and helpful answers based strictly on the information in these documents. You must not hallucinate or invent any information. If the answer cannot be found in the documents, politely inform the user. If you do not know the answer to a question, you truthfully say you do not know.\n\nWhen the user asks a question, follow these steps:\n\n1. **Check for Acronyms**:\n   - If the user's input contains an acronym (e.g., CBA, LAEP):\n     - Use the **glossary_lookup** tool to fetch the definition of the acronym from the glossary.\n     - After retrieving the definition, ask the user: \"Is '{definition}' what you meant by {acronym}? (Yes/No)\".\n       - The definition should be **explicitly provided** in the confirmation question. For example: \"Is 'Cost-Benefit Analysis' what you meant by CBA? (Yes/No)\".\n     - If the user confirms with \"Yes\":\n       - Proceed by using the **vector search** function to retrieve relevant context from the RAG system, **enhancing the context with the acronym's definition**.\n       - Craft your answer based on the retrieved context and the acronym's definition, ensuring that you include the **file name** and other relevant metadata in the response.\n     - If the user does **not** confirm the definition with \"Yes\":\n       - Politely ask the user for more clarification by saying: \"Could you please provide more context or clarify what you mean by {acronym}?\" and do **not** proceed to context retrieval until you receive further clarification.\n\n2. **If No Acronym is Present**:\n   - If the user's input **does not contain an acronym**, proceed directly to **vector search** to retrieve the relevant context based on the question.\n   - Craft your answer based on the retrieved context, ensuring you include the **file name** and other relevant metadata.\n\n3. **Contextual Answering**:\n   - After the acronym is validated (or if no acronym is present), use the retrieved context from the vector search to answer the question directly.\n   - Include the **file_name** (or any other relevant metadata) from the context to show where the information was retrieved from, for example, \"The information was retrieved from the document: {file_name}\".\n   - Do not include any unnecessary explanations about the context or the process.\n\nHere is the history of the current conversation you are having with your user: {chat_history}. And here is some context which may or may not help you answer the following question: {context}. Answer directly, do not repeat the question, do not start with something like: \"the answer to the question\", do not add \"AI\" in front of your answer, do not say: \"here is the answer\", do not mention the context or the question. Based on this context, answer this question: {question}.\n"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Hi"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "Welcome! I'm here to help with any questions you have about energy regulation and policies. Please go ahead and ask your question, and I'll do my best to provide a helpful and accurate answer based on the information available in the official documents."
#                 },
#                 {
#                     "role": "user",
#                     "content": "how is cba applied?"
#                 }
#             ]
#         },
#         "expected_response": None
#     },
#     {
#         "request": {
#             "messages": [
#                 {
#                     "role": "system",
#                     "content": "You are a highly knowledgeable assistant specializing in answering questions about energy regulation and policies. You have access to a knowledge base of official documents. Your goal is to provide accurate, concise, and helpful answers based strictly on the information in these documents. You must not hallucinate or invent any information. If the answer cannot be found in the documents, politely inform the user. If you do not know the answer to a question, you truthfully say you do not know.\n\nWhen the user asks a question, follow these steps:\n\n1. **Check for Acronyms**:\n   - If the user's input contains an acronym (e.g., CBA, LAEP):\n     - Use the **glossary_lookup** tool to fetch the definition of the acronym from the glossary.\n     - After retrieving the definition, ask the user: \"Is '{definition}' what you meant by {acronym}? (Yes/No)\".\n       - The definition should be **explicitly provided** in the confirmation question. For example: \"Is 'Cost-Benefit Analysis' what you meant by CBA? (Yes/No)\".\n     - If the user confirms with \"Yes\":\n       - Proceed by using the **vector search** function to retrieve relevant context from the RAG system, **enhancing the context with the acronym's definition**.\n       - Craft your answer based on the retrieved context and the acronym's definition, ensuring that you include the **file name** and other relevant metadata in the response.\n     - If the user does **not** confirm the definition with \"Yes\":\n       - Politely ask the user for more clarification by saying: \"Could you please provide more context or clarify what you mean by {acronym}?\" and do **not** proceed to context retrieval until you receive further clarification.\n\n2. **If No Acronym is Present**:\n   - If the user's input **does not contain an acronym**, proceed directly to **vector search** to retrieve the relevant context based on the question.\n   - Craft your answer based on the retrieved context, ensuring you include the **file name** and other relevant metadata.\n\n3. **Contextual Answering**:\n   - After the acronym is validated (or if no acronym is present), use the retrieved context from the vector search to answer the question directly.\n   - Include the **file_name** (or any other relevant metadata) from the context to show where the information was retrieved from, for example, \"The information was retrieved from the document: {file_name}\".\n   - Do not include any unnecessary explanations about the context or the process.\n\nHere is the history of the current conversation you are having with your user: {chat_history}. And here is some context which may or may not help you answer the following question: {context}. Answer directly, do not repeat the question, do not start with something like: \"the answer to the question\", do not add \"AI\" in front of your answer, do not say: \"here is the answer\", do not mention the context or the question. Based on this context, answer this question: {question}.\n"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Hi"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "Welcome! I'm here to help with any questions you have about energy regulation and policies. Please go ahead and ask your question, and I'll do my best to provide a helpful and accurate answer based on the information available in the official documents."
#                 },
#                 {
#                     "role": "user",
#                     "content": "how is cba applied?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "The user's input contains an acronym 'CBA' which needs to be defined before proceeding with the question. The definition of 'CBA' will help in understanding the context of the question and provide a more accurate answer.\n\n<uc_function_call>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"name\":\"kyra_wulffert.poc_doc_management.lookup_glossary\",\"arguments\":\"{\\\"input_acronym\\\":\\\"CBA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"definition\\\",\\\"certainty\\\"],\\\"rows\\\":[[\\\"Cost Benefit Analysis\\\",100]]}\"}</uc_function_result>\n\nTo find out how Cost Benefit Analysis (CBA) is applied, I need to search the documentation for relevant information on this topic.\n\n<uc_function_call>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"name\":\"kyra_wulffert.poc_doc_management.search_documentation\",\"arguments\":\"{\\\"topic\\\":\\\"Cost Benefit Analysis application\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"uuid\\\",\\\"content\\\",\\\"category\\\",\\\"char_length\\\",\\\"chunk_num\\\",\\\"file_name\\\",\\\"file_extension\\\",\\\"num_pages\\\",\\\"length\\\",\\\"year\\\",\\\"score\\\"],\\\"rows\\\":[[\\\"RIIO-ED2 Final Determinations Core Methodology.pdf\\\",\\\"required in this area and that consistency in how benefits are measured across network companies and sectors can improve. We plan to work with network companies on this during RIIO-ED2.\\\\n\\\\n3.118 Furthermore, we will consult on adding a requirement to NIA governance for network companies to publish benefit statements including cost- benefit calculations alongside project progress information, to increase transparency.\\\\n\\\\nCarry-over RIIO-1 Network Innovation Allowance\\\\n\\\\nPurpose\\\\n\\\\nTo prevent the abrupt ending of some RIIO-1 NIA\\\\n\\\\nprojects, and potential reductions in innovation activity.\\\\n\\\\nBenefits\\\\n\\\\nTo enable project delivery and completion, and resulting\\\\n\\\\nlessons learned to be shared across industry, with\\\\n\\\\npotential consumer benefits.\\\\n\\\\nFinal Determination summary\\\\n\\\\n3.119 The table below provides a summary of our Final Determination position.\\\\n\\\\n43\\\\n\\\\nDecision – RIIO-ED2 Final Determinations Core Methodology Document\\\\n\\\\nParameter\\\\n\\\\nFinal Determination\\\\n\\\\nDraft Determination\\\\n\\\\nEnd date for spending RIIO- ED1 NIA funds\\\",\\\"CompositeElement\\\",1010.0,84.0,\\\"RIIO-ED2 Final Determinations Core Methodology.pdf_84\\\",\\\".pdf\\\",364.0,857803.0,\\\"2022\\\",0.0022498108],[\\\"DSO_Incentive_Report_2023-24.pdf\\\",\\\"cost benefit analysis or other actions being highlighted in submissions. The\\\\n\\\\nevidence provided should refer as explicitly as possible to the submission year\\\\n\\\\nwith clear timelines whenever possible. Given the varying factors influencing\\\\n\\\\nstrategic decision-making, it is essential that submissions demonstrate the full\\\\n\\\\n15\\\\n\\\\nReport\\\\n\\\\ncontext of decisions and performance figures for the Panel to make informed\\\\n\\\\njudgement.\\\\n\\\\n4.17\\\\n\\\\nFor example, there were many different approaches to DSO governance\\\\n\\\\ndemonstrated across DNO submissions. However, the evidence sometimes didn’t\\\\n\\\\nfully justify why an approach was chosen over other potential options and why it\\\\n\\\\nrepresented the most value for customers and stakeholders.\\\\n\\\\n4.18\\\\n\\\\nSimilarly, more substantive evidence is expected regarding the impact and\\\\n\\\\nresults of discussed activities. For example, the Panel noted that having an\\\\n\\\\nIndependent Panel is not beneficial by default, so DNOs are encouraged to\\\\n\\\\ndemonstrate the impact the Independent Panel has had, how this has\\\",\\\"CompositeElement\\\",1015.0,24.0,\\\"DSO_Incentive_Report_2023-24.pdf_24\\\",\\\".pdf\\\",38.0,83332.0,\\\"2024\\\",0.0022015206],[\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf\\\",\\\"Setting ex ante allowances .............................................................. 32 Introduction ....................................................................................... 32 Ex ante allowances .............................................................................. 32 Technically assessed costs ................................................................... 37 Engineering Justification Paper review .................................................... 38 TIM ................................................................................................... 42 BPI Stage 3 ........................................................................................ 42 BPI Stage 4 ........................................................................................ 43 4. Adjusting ex ante allowances for uncertainty .................................. 44 Introduction ....................................................................................... 44 Bespoke UM Proposals ......................................................................... 44 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf_2\\\",\\\".pdf\\\",71.0,116133.0,\\\"2022\\\",0.0021417236],[\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf\\\",\\\"Setting ex ante allowances .............................................................. 28 Introduction ....................................................................................... 28 Ex ante allowances .............................................................................. 28 Technically assessed costs ................................................................... 30 Engineering Justification Paper review .................................................... 31 TIM ................................................................................................... 33 BPI Stage 3 ........................................................................................ 33 BPI Stage 4 ........................................................................................ 33 4. Adjusting ex ante allowances for uncertainty .................................. 35 Introduction ....................................................................................... 35 Bespoke UM Proposals ......................................................................... 35 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf_2\\\",\\\".pdf\\\",53.0,82947.0,\\\"2022\\\",0.0021324502],[\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf\\\",\\\"measured in previous iterations relative to the defined RIIO-1 counterfactual and\\\\n\\\\nbased on a transparent set of assumptions which were set out in the previous IAs.\\\\n\\\\nThis final IA updates that analysis presented in the DD IA to reflect the actual\\\\n\\\\nvalues and approaches as set out in our Final Determinations.\\\\n\\\\n2.3 Over the five-year RIIO-ED2 period, we expect our Final Determinations to deliver\\\\n\\\\nnet benefits to consumers of up to £428m, relative to the counterfactual. The\\\\n\\\\ndominant quantified effect arises from a resetting (lowering) of the cost of equity\\\\n\\\\nto current market rates, which drives a large transfer from investors to\\\\n\\\\nconsumers, compared to the counterfactual. The £428m consumer benefits value\\\\n\\\\nis lower compared to that assessed in the DD IA given changes in market\\\\n\\\\nconditions (higher interest rates) that influence the cost of capital and higher totex\\\\n\\\\nallowances proposed for each of the companies.\\\\n\\\\n2.4\\\\n\\\\nThere are different ways consumer benefits can be calculated. In this IA, the\\\",\\\"CompositeElement\\\",1005.0,7.0,\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf_7\\\",\\\".pdf\\\",62.0,125232.0,\\\"2022\\\",0.0021262604]]}\"}</uc_function_result>\n\nIs 'Cost Benefit Analysis' what you meant by CBA? (Yes/No)"
#                 },
#                 {
#                     "role": "user",
#                     "content": "I don't know what you are asking"
#                 }
#             ]
#         },
#         "expected_response": None
#     },
#     {
#         "request": {
#             "messages": [
#                 {
#                     "role": "system",
#                     "content": "You are a highly knowledgeable assistant specializing in answering questions about energy regulation and policies. You have access to a knowledge base of official documents. Your goal is to provide accurate, concise, and helpful answers based strictly on the information in these documents. You must not hallucinate or invent any information. If the answer cannot be found in the documents, politely inform the user. If you do not know the answer to a question, you truthfully say you do not know.\n\nWhen the user asks a question, follow these steps:\n\n1. **Check for Acronyms**:\n   - If the user's input contains an acronym (e.g., CBA, LAEP):\n     - Use the **glossary_lookup** tool to fetch the definition of the acronym from the glossary.\n     - After retrieving the definition, ask the user: \"Is '{definition}' what you meant by {acronym}? (Yes/No)\".\n       - The definition should be **explicitly provided** in the confirmation question. For example: \"Is 'Cost-Benefit Analysis' what you meant by CBA? (Yes/No)\".\n     - If the user confirms with \"Yes\":\n       - Proceed by using the **vector search** function to retrieve relevant context from the RAG system, **enhancing the context with the acronym's definition**.\n       - Craft your answer based on the retrieved context and the acronym's definition, ensuring that you include the **file name** and other relevant metadata in the response.\n     - If the user does **not** confirm the definition with \"Yes\":\n       - Politely ask the user for more clarification by saying: \"Could you please provide more context or clarify what you mean by {acronym}?\" and do **not** proceed to context retrieval until you receive further clarification.\n\n2. **If No Acronym is Present**:\n   - If the user's input **does not contain an acronym**, proceed directly to **vector search** to retrieve the relevant context based on the question.\n   - Craft your answer based on the retrieved context, ensuring you include the **file name** and other relevant metadata.\n\n3. **Contextual Answering**:\n   - After the acronym is validated (or if no acronym is present), use the retrieved context from the vector search to answer the question directly.\n   - Include the **file_name** (or any other relevant metadata) from the context to show where the information was retrieved from, for example, \"The information was retrieved from the document: {file_name}\".\n   - Do not include any unnecessary explanations about the context or the process.\n\nHere is the history of the current conversation you are having with your user: {chat_history}. And here is some context which may or may not help you answer the following question: {context}. Answer directly, do not repeat the question, do not start with something like: \"the answer to the question\", do not add \"AI\" in front of your answer, do not say: \"here is the answer\", do not mention the context or the question. Based on this context, answer this question: {question}.\n"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Hi"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "Welcome! I'm here to help with any questions you have about energy regulation and policies. Please go ahead and ask your question, and I'll do my best to provide a helpful and accurate answer based on the information available in the official documents."
#                 },
#                 {
#                     "role": "user",
#                     "content": "how is cba applied?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "The user's input contains an acronym 'CBA' which needs to be defined before proceeding with the question. The definition of 'CBA' will help in understanding the context of the question and provide a more accurate answer.\n\n<uc_function_call>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"name\":\"kyra_wulffert.poc_doc_management.lookup_glossary\",\"arguments\":\"{\\\"input_acronym\\\":\\\"CBA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"definition\\\",\\\"certainty\\\"],\\\"rows\\\":[[\\\"Cost Benefit Analysis\\\",100]]}\"}</uc_function_result>\n\nTo find out how Cost Benefit Analysis (CBA) is applied, I need to search the documentation for relevant information on this topic.\n\n<uc_function_call>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"name\":\"kyra_wulffert.poc_doc_management.search_documentation\",\"arguments\":\"{\\\"topic\\\":\\\"Cost Benefit Analysis application\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"uuid\\\",\\\"content\\\",\\\"category\\\",\\\"char_length\\\",\\\"chunk_num\\\",\\\"file_name\\\",\\\"file_extension\\\",\\\"num_pages\\\",\\\"length\\\",\\\"year\\\",\\\"score\\\"],\\\"rows\\\":[[\\\"RIIO-ED2 Final Determinations Core Methodology.pdf\\\",\\\"required in this area and that consistency in how benefits are measured across network companies and sectors can improve. We plan to work with network companies on this during RIIO-ED2.\\\\n\\\\n3.118 Furthermore, we will consult on adding a requirement to NIA governance for network companies to publish benefit statements including cost- benefit calculations alongside project progress information, to increase transparency.\\\\n\\\\nCarry-over RIIO-1 Network Innovation Allowance\\\\n\\\\nPurpose\\\\n\\\\nTo prevent the abrupt ending of some RIIO-1 NIA\\\\n\\\\nprojects, and potential reductions in innovation activity.\\\\n\\\\nBenefits\\\\n\\\\nTo enable project delivery and completion, and resulting\\\\n\\\\nlessons learned to be shared across industry, with\\\\n\\\\npotential consumer benefits.\\\\n\\\\nFinal Determination summary\\\\n\\\\n3.119 The table below provides a summary of our Final Determination position.\\\\n\\\\n43\\\\n\\\\nDecision – RIIO-ED2 Final Determinations Core Methodology Document\\\\n\\\\nParameter\\\\n\\\\nFinal Determination\\\\n\\\\nDraft Determination\\\\n\\\\nEnd date for spending RIIO- ED1 NIA funds\\\",\\\"CompositeElement\\\",1010.0,84.0,\\\"RIIO-ED2 Final Determinations Core Methodology.pdf_84\\\",\\\".pdf\\\",364.0,857803.0,\\\"2022\\\",0.0022498108],[\\\"DSO_Incentive_Report_2023-24.pdf\\\",\\\"cost benefit analysis or other actions being highlighted in submissions. The\\\\n\\\\nevidence provided should refer as explicitly as possible to the submission year\\\\n\\\\nwith clear timelines whenever possible. Given the varying factors influencing\\\\n\\\\nstrategic decision-making, it is essential that submissions demonstrate the full\\\\n\\\\n15\\\\n\\\\nReport\\\\n\\\\ncontext of decisions and performance figures for the Panel to make informed\\\\n\\\\njudgement.\\\\n\\\\n4.17\\\\n\\\\nFor example, there were many different approaches to DSO governance\\\\n\\\\ndemonstrated across DNO submissions. However, the evidence sometimes didn’t\\\\n\\\\nfully justify why an approach was chosen over other potential options and why it\\\\n\\\\nrepresented the most value for customers and stakeholders.\\\\n\\\\n4.18\\\\n\\\\nSimilarly, more substantive evidence is expected regarding the impact and\\\\n\\\\nresults of discussed activities. For example, the Panel noted that having an\\\\n\\\\nIndependent Panel is not beneficial by default, so DNOs are encouraged to\\\\n\\\\ndemonstrate the impact the Independent Panel has had, how this has\\\",\\\"CompositeElement\\\",1015.0,24.0,\\\"DSO_Incentive_Report_2023-24.pdf_24\\\",\\\".pdf\\\",38.0,83332.0,\\\"2024\\\",0.0022015206],[\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf\\\",\\\"Setting ex ante allowances .............................................................. 32 Introduction ....................................................................................... 32 Ex ante allowances .............................................................................. 32 Technically assessed costs ................................................................... 37 Engineering Justification Paper review .................................................... 38 TIM ................................................................................................... 42 BPI Stage 3 ........................................................................................ 42 BPI Stage 4 ........................................................................................ 43 4. Adjusting ex ante allowances for uncertainty .................................. 44 Introduction ....................................................................................... 44 Bespoke UM Proposals ......................................................................... 44 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf_2\\\",\\\".pdf\\\",71.0,116133.0,\\\"2022\\\",0.0021417236],[\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf\\\",\\\"Setting ex ante allowances .............................................................. 28 Introduction ....................................................................................... 28 Ex ante allowances .............................................................................. 28 Technically assessed costs ................................................................... 30 Engineering Justification Paper review .................................................... 31 TIM ................................................................................................... 33 BPI Stage 3 ........................................................................................ 33 BPI Stage 4 ........................................................................................ 33 4. Adjusting ex ante allowances for uncertainty .................................. 35 Introduction ....................................................................................... 35 Bespoke UM Proposals ......................................................................... 35 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf_2\\\",\\\".pdf\\\",53.0,82947.0,\\\"2022\\\",0.0021324502],[\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf\\\",\\\"measured in previous iterations relative to the defined RIIO-1 counterfactual and\\\\n\\\\nbased on a transparent set of assumptions which were set out in the previous IAs.\\\\n\\\\nThis final IA updates that analysis presented in the DD IA to reflect the actual\\\\n\\\\nvalues and approaches as set out in our Final Determinations.\\\\n\\\\n2.3 Over the five-year RIIO-ED2 period, we expect our Final Determinations to deliver\\\\n\\\\nnet benefits to consumers of up to £428m, relative to the counterfactual. The\\\\n\\\\ndominant quantified effect arises from a resetting (lowering) of the cost of equity\\\\n\\\\nto current market rates, which drives a large transfer from investors to\\\\n\\\\nconsumers, compared to the counterfactual. The £428m consumer benefits value\\\\n\\\\nis lower compared to that assessed in the DD IA given changes in market\\\\n\\\\nconditions (higher interest rates) that influence the cost of capital and higher totex\\\\n\\\\nallowances proposed for each of the companies.\\\\n\\\\n2.4\\\\n\\\\nThere are different ways consumer benefits can be calculated. In this IA, the\\\",\\\"CompositeElement\\\",1005.0,7.0,\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf_7\\\",\\\".pdf\\\",62.0,125232.0,\\\"2022\\\",0.0021262604]]}\"}</uc_function_result>\n\nIs 'Cost Benefit Analysis' what you meant by CBA? (Yes/No)"
#                 },
#                 {
#                     "role": "user",
#                     "content": "I don't know what you are asking"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "I was asking if you meant \"Cost Benefit Analysis\" when you used the acronym \"CBA\". But since you're not sure, let me clarify. I found that \"CBA\" stands for \"Cost Benefit Analysis\" in the context of energy regulation and policies. \n\nTo answer your original question, \"how is CBA applied?\", I found some relevant information in the documents. According to the document \"RIIO-ED2 Final Determinations Core Methodology.pdf\", a cost-benefit analysis is required for certain projects, and network companies are expected to publish benefit statements, including cost-benefit calculations, alongside project progress information. \n\nAdditionally, the document \"DSO_Incentive_Report_2023-24.pdf\" mentions that cost-benefit analysis or other actions should be highlighted in submissions, and that evidence should be provided to demonstrate the full context of decisions and performance figures.\n\nPlease let me know if you'd like me to elaborate or provide more information."
#                 },
#                 {
#                     "role": "user",
#                     "content": "it's great"
#                 }
#             ]
#         },
#         "expected_response": None
#     },
#     {
#         "request": {
#             "messages": [
#                 {
#                     "role": "system",
#                     "content": "You are a highly knowledgeable assistant specializing in answering questions about energy regulation and policies. You have access to a knowledge base of official documents. Your goal is to provide accurate, concise, and helpful answers based strictly on the information in these documents. You must not hallucinate or invent any information. If the answer cannot be found in the documents, politely inform the user. If you do not know the answer to a question, you truthfully say you do not know.\n\nWhen the user asks a question, follow these steps:\n\n1. **Check for Acronyms**:\n   - If the user's input contains an acronym (e.g., CBA, LAEP):\n     - Use the **glossary_lookup** tool to fetch the definition of the acronym from the glossary.\n     - After retrieving the definition, ask the user: \"Is '{definition}' what you meant by {acronym}? (Yes/No)\".\n       - The definition should be **explicitly provided** in the confirmation question. For example: \"Is 'Cost-Benefit Analysis' what you meant by CBA? (Yes/No)\".\n     - If the user confirms with \"Yes\":\n       - Proceed by using the **vector search** function to retrieve relevant context from the RAG system, **enhancing the context with the acronym's definition**.\n       - Craft your answer based on the retrieved context and the acronym's definition, ensuring that you include the **file name** and other relevant metadata in the response.\n     - If the user does **not** confirm the definition with \"Yes\":\n       - Politely ask the user for more clarification by saying: \"Could you please provide more context or clarify what you mean by {acronym}?\" and do **not** proceed to context retrieval until you receive further clarification.\n\n2. **If No Acronym is Present**:\n   - If the user's input **does not contain an acronym**, proceed directly to **vector search** to retrieve the relevant context based on the question.\n   - Craft your answer based on the retrieved context, ensuring you include the **file name** and other relevant metadata.\n\n3. **Contextual Answering**:\n   - After the acronym is validated (or if no acronym is present), use the retrieved context from the vector search to answer the question directly.\n   - Include the **file_name** (or any other relevant metadata) from the context to show where the information was retrieved from, for example, \"The information was retrieved from the document: {file_name}\".\n   - Do not include any unnecessary explanations about the context or the process.\n\nHere is the history of the current conversation you are having with your user: {chat_history}. And here is some context which may or may not help you answer the following question: {context}. Answer directly, do not repeat the question, do not start with something like: \"the answer to the question\", do not add \"AI\" in front of your answer, do not say: \"here is the answer\", do not mention the context or the question. Based on this context, answer this question: {question}.\n"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Hi"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "Welcome! I'm here to help with any questions you have about energy regulation and policies. Please go ahead and ask your question, and I'll do my best to provide a helpful and accurate answer based on the information available in the official documents."
#                 },
#                 {
#                     "role": "user",
#                     "content": "how is cba applied?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "The user's input contains an acronym 'CBA' which needs to be defined before proceeding with the question. The definition of 'CBA' will help in understanding the context of the question and provide a more accurate answer.\n\n<uc_function_call>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"name\":\"kyra_wulffert.poc_doc_management.lookup_glossary\",\"arguments\":\"{\\\"input_acronym\\\":\\\"CBA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"definition\\\",\\\"certainty\\\"],\\\"rows\\\":[[\\\"Cost Benefit Analysis\\\",100]]}\"}</uc_function_result>\n\nTo find out how Cost Benefit Analysis (CBA) is applied, I need to search the documentation for relevant information on this topic.\n\n<uc_function_call>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"name\":\"kyra_wulffert.poc_doc_management.search_documentation\",\"arguments\":\"{\\\"topic\\\":\\\"Cost Benefit Analysis application\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"uuid\\\",\\\"content\\\",\\\"category\\\",\\\"char_length\\\",\\\"chunk_num\\\",\\\"file_name\\\",\\\"file_extension\\\",\\\"num_pages\\\",\\\"length\\\",\\\"year\\\",\\\"score\\\"],\\\"rows\\\":[[\\\"RIIO-ED2 Final Determinations Core Methodology.pdf\\\",\\\"required in this area and that consistency in how benefits are measured across network companies and sectors can improve. We plan to work with network companies on this during RIIO-ED2.\\\\n\\\\n3.118 Furthermore, we will consult on adding a requirement to NIA governance for network companies to publish benefit statements including cost- benefit calculations alongside project progress information, to increase transparency.\\\\n\\\\nCarry-over RIIO-1 Network Innovation Allowance\\\\n\\\\nPurpose\\\\n\\\\nTo prevent the abrupt ending of some RIIO-1 NIA\\\\n\\\\nprojects, and potential reductions in innovation activity.\\\\n\\\\nBenefits\\\\n\\\\nTo enable project delivery and completion, and resulting\\\\n\\\\nlessons learned to be shared across industry, with\\\\n\\\\npotential consumer benefits.\\\\n\\\\nFinal Determination summary\\\\n\\\\n3.119 The table below provides a summary of our Final Determination position.\\\\n\\\\n43\\\\n\\\\nDecision – RIIO-ED2 Final Determinations Core Methodology Document\\\\n\\\\nParameter\\\\n\\\\nFinal Determination\\\\n\\\\nDraft Determination\\\\n\\\\nEnd date for spending RIIO- ED1 NIA funds\\\",\\\"CompositeElement\\\",1010.0,84.0,\\\"RIIO-ED2 Final Determinations Core Methodology.pdf_84\\\",\\\".pdf\\\",364.0,857803.0,\\\"2022\\\",0.0022498108],[\\\"DSO_Incentive_Report_2023-24.pdf\\\",\\\"cost benefit analysis or other actions being highlighted in submissions. The\\\\n\\\\nevidence provided should refer as explicitly as possible to the submission year\\\\n\\\\nwith clear timelines whenever possible. Given the varying factors influencing\\\\n\\\\nstrategic decision-making, it is essential that submissions demonstrate the full\\\\n\\\\n15\\\\n\\\\nReport\\\\n\\\\ncontext of decisions and performance figures for the Panel to make informed\\\\n\\\\njudgement.\\\\n\\\\n4.17\\\\n\\\\nFor example, there were many different approaches to DSO governance\\\\n\\\\ndemonstrated across DNO submissions. However, the evidence sometimes didn’t\\\\n\\\\nfully justify why an approach was chosen over other potential options and why it\\\\n\\\\nrepresented the most value for customers and stakeholders.\\\\n\\\\n4.18\\\\n\\\\nSimilarly, more substantive evidence is expected regarding the impact and\\\\n\\\\nresults of discussed activities. For example, the Panel noted that having an\\\\n\\\\nIndependent Panel is not beneficial by default, so DNOs are encouraged to\\\\n\\\\ndemonstrate the impact the Independent Panel has had, how this has\\\",\\\"CompositeElement\\\",1015.0,24.0,\\\"DSO_Incentive_Report_2023-24.pdf_24\\\",\\\".pdf\\\",38.0,83332.0,\\\"2024\\\",0.0022015206],[\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf\\\",\\\"Setting ex ante allowances .............................................................. 32 Introduction ....................................................................................... 32 Ex ante allowances .............................................................................. 32 Technically assessed costs ................................................................... 37 Engineering Justification Paper review .................................................... 38 TIM ................................................................................................... 42 BPI Stage 3 ........................................................................................ 42 BPI Stage 4 ........................................................................................ 43 4. Adjusting ex ante allowances for uncertainty .................................. 44 Introduction ....................................................................................... 44 Bespoke UM Proposals ......................................................................... 44 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf_2\\\",\\\".pdf\\\",71.0,116133.0,\\\"2022\\\",0.0021417236],[\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf\\\",\\\"Setting ex ante allowances .............................................................. 28 Introduction ....................................................................................... 28 Ex ante allowances .............................................................................. 28 Technically assessed costs ................................................................... 30 Engineering Justification Paper review .................................................... 31 TIM ................................................................................................... 33 BPI Stage 3 ........................................................................................ 33 BPI Stage 4 ........................................................................................ 33 4. Adjusting ex ante allowances for uncertainty .................................. 35 Introduction ....................................................................................... 35 Bespoke UM Proposals ......................................................................... 35 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf_2\\\",\\\".pdf\\\",53.0,82947.0,\\\"2022\\\",0.0021324502],[\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf\\\",\\\"measured in previous iterations relative to the defined RIIO-1 counterfactual and\\\\n\\\\nbased on a transparent set of assumptions which were set out in the previous IAs.\\\\n\\\\nThis final IA updates that analysis presented in the DD IA to reflect the actual\\\\n\\\\nvalues and approaches as set out in our Final Determinations.\\\\n\\\\n2.3 Over the five-year RIIO-ED2 period, we expect our Final Determinations to deliver\\\\n\\\\nnet benefits to consumers of up to £428m, relative to the counterfactual. The\\\\n\\\\ndominant quantified effect arises from a resetting (lowering) of the cost of equity\\\\n\\\\nto current market rates, which drives a large transfer from investors to\\\\n\\\\nconsumers, compared to the counterfactual. The £428m consumer benefits value\\\\n\\\\nis lower compared to that assessed in the DD IA given changes in market\\\\n\\\\nconditions (higher interest rates) that influence the cost of capital and higher totex\\\\n\\\\nallowances proposed for each of the companies.\\\\n\\\\n2.4\\\\n\\\\nThere are different ways consumer benefits can be calculated. In this IA, the\\\",\\\"CompositeElement\\\",1005.0,7.0,\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf_7\\\",\\\".pdf\\\",62.0,125232.0,\\\"2022\\\",0.0021262604]]}\"}</uc_function_result>\n\nIs 'Cost Benefit Analysis' what you meant by CBA? (Yes/No)"
#                 },
#                 {
#                     "role": "user",
#                     "content": "I don't know what you are asking"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "I was asking if you meant \"Cost Benefit Analysis\" when you used the acronym \"CBA\". But since you're not sure, let me clarify. I found that \"CBA\" stands for \"Cost Benefit Analysis\" in the context of energy regulation and policies. \n\nTo answer your original question, \"how is CBA applied?\", I found some relevant information in the documents. According to the document \"RIIO-ED2 Final Determinations Core Methodology.pdf\", a cost-benefit analysis is required for certain projects, and network companies are expected to publish benefit statements, including cost-benefit calculations, alongside project progress information. \n\nAdditionally, the document \"DSO_Incentive_Report_2023-24.pdf\" mentions that cost-benefit analysis or other actions should be highlighted in submissions, and that evidence should be provided to demonstrate the full context of decisions and performance figures.\n\nPlease let me know if you'd like me to elaborate or provide more information."
#                 },
#                 {
#                     "role": "user",
#                     "content": "it's great"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "I'm glad I could provide a helpful answer. If you have any more questions or need further clarification on anything, feel free to ask!"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Can you explain what CBA means in the context of the DSO Incentive Report?"
#                 }
#             ]
#         },
#         "expected_response": None
#     },
#     {
#         "request": {
#             "messages": [
#                 {
#                     "role": "system",
#                     "content": "You are a highly knowledgeable assistant specializing in answering questions about energy regulation and policies. You have access to a knowledge base of official documents. Your goal is to provide accurate, concise, and helpful answers based strictly on the information in these documents. You must not hallucinate or invent any information. If the answer cannot be found in the documents, politely inform the user. If you do not know the answer to a question, you truthfully say you do not know.\n\nWhen the user asks a question, follow these steps:\n\n1. **Check for Acronyms**:\n   - If the user's input contains an acronym (e.g., CBA, LAEP):\n     - Use the **glossary_lookup** tool to fetch the definition of the acronym from the glossary.\n     - After retrieving the definition, ask the user: \"Is '{definition}' what you meant by {acronym}? (Yes/No)\".\n       - The definition should be **explicitly provided** in the confirmation question. For example: \"Is 'Cost-Benefit Analysis' what you meant by CBA? (Yes/No)\".\n     - If the user confirms with \"Yes\":\n       - Proceed by using the **vector search** function to retrieve relevant context from the RAG system, **enhancing the context with the acronym's definition**.\n       - Craft your answer based on the retrieved context and the acronym's definition, ensuring that you include the **file name** and other relevant metadata in the response.\n     - If the user does **not** confirm the definition with \"Yes\":\n       - Politely ask the user for more clarification by saying: \"Could you please provide more context or clarify what you mean by {acronym}?\" and do **not** proceed to context retrieval until you receive further clarification.\n\n2. **If No Acronym is Present**:\n   - If the user's input **does not contain an acronym**, proceed directly to **vector search** to retrieve the relevant context based on the question.\n   - Craft your answer based on the retrieved context, ensuring you include the **file name** and other relevant metadata.\n\n3. **Contextual Answering**:\n   - After the acronym is validated (or if no acronym is present), use the retrieved context from the vector search to answer the question directly.\n   - Include the **file_name** (or any other relevant metadata) from the context to show where the information was retrieved from, for example, \"The information was retrieved from the document: {file_name}\".\n   - Do not include any unnecessary explanations about the context or the process.\n\nHere is the history of the current conversation you are having with your user: {chat_history}. And here is some context which may or may not help you answer the following question: {context}. Answer directly, do not repeat the question, do not start with something like: \"the answer to the question\", do not add \"AI\" in front of your answer, do not say: \"here is the answer\", do not mention the context or the question. Based on this context, answer this question: {question}.\n"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Hi"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "Welcome! I'm here to help with any questions you have about energy regulation and policies. Please go ahead and ask your question, and I'll do my best to provide a helpful and accurate answer based on the information available in the official documents."
#                 },
#                 {
#                     "role": "user",
#                     "content": "how is cba applied?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "The user's input contains an acronym 'CBA' which needs to be defined before proceeding with the question. The definition of 'CBA' will help in understanding the context of the question and provide a more accurate answer.\n\n<uc_function_call>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"name\":\"kyra_wulffert.poc_doc_management.lookup_glossary\",\"arguments\":\"{\\\"input_acronym\\\":\\\"CBA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"definition\\\",\\\"certainty\\\"],\\\"rows\\\":[[\\\"Cost Benefit Analysis\\\",100]]}\"}</uc_function_result>\n\nTo find out how Cost Benefit Analysis (CBA) is applied, I need to search the documentation for relevant information on this topic.\n\n<uc_function_call>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"name\":\"kyra_wulffert.poc_doc_management.search_documentation\",\"arguments\":\"{\\\"topic\\\":\\\"Cost Benefit Analysis application\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"uuid\\\",\\\"content\\\",\\\"category\\\",\\\"char_length\\\",\\\"chunk_num\\\",\\\"file_name\\\",\\\"file_extension\\\",\\\"num_pages\\\",\\\"length\\\",\\\"year\\\",\\\"score\\\"],\\\"rows\\\":[[\\\"RIIO-ED2 Final Determinations Core Methodology.pdf\\\",\\\"required in this area and that consistency in how benefits are measured across network companies and sectors can improve. We plan to work with network companies on this during RIIO-ED2.\\\\n\\\\n3.118 Furthermore, we will consult on adding a requirement to NIA governance for network companies to publish benefit statements including cost- benefit calculations alongside project progress information, to increase transparency.\\\\n\\\\nCarry-over RIIO-1 Network Innovation Allowance\\\\n\\\\nPurpose\\\\n\\\\nTo prevent the abrupt ending of some RIIO-1 NIA\\\\n\\\\nprojects, and potential reductions in innovation activity.\\\\n\\\\nBenefits\\\\n\\\\nTo enable project delivery and completion, and resulting\\\\n\\\\nlessons learned to be shared across industry, with\\\\n\\\\npotential consumer benefits.\\\\n\\\\nFinal Determination summary\\\\n\\\\n3.119 The table below provides a summary of our Final Determination position.\\\\n\\\\n43\\\\n\\\\nDecision – RIIO-ED2 Final Determinations Core Methodology Document\\\\n\\\\nParameter\\\\n\\\\nFinal Determination\\\\n\\\\nDraft Determination\\\\n\\\\nEnd date for spending RIIO- ED1 NIA funds\\\",\\\"CompositeElement\\\",1010.0,84.0,\\\"RIIO-ED2 Final Determinations Core Methodology.pdf_84\\\",\\\".pdf\\\",364.0,857803.0,\\\"2022\\\",0.0022498108],[\\\"DSO_Incentive_Report_2023-24.pdf\\\",\\\"cost benefit analysis or other actions being highlighted in submissions. The\\\\n\\\\nevidence provided should refer as explicitly as possible to the submission year\\\\n\\\\nwith clear timelines whenever possible. Given the varying factors influencing\\\\n\\\\nstrategic decision-making, it is essential that submissions demonstrate the full\\\\n\\\\n15\\\\n\\\\nReport\\\\n\\\\ncontext of decisions and performance figures for the Panel to make informed\\\\n\\\\njudgement.\\\\n\\\\n4.17\\\\n\\\\nFor example, there were many different approaches to DSO governance\\\\n\\\\ndemonstrated across DNO submissions. However, the evidence sometimes didn’t\\\\n\\\\nfully justify why an approach was chosen over other potential options and why it\\\\n\\\\nrepresented the most value for customers and stakeholders.\\\\n\\\\n4.18\\\\n\\\\nSimilarly, more substantive evidence is expected regarding the impact and\\\\n\\\\nresults of discussed activities. For example, the Panel noted that having an\\\\n\\\\nIndependent Panel is not beneficial by default, so DNOs are encouraged to\\\\n\\\\ndemonstrate the impact the Independent Panel has had, how this has\\\",\\\"CompositeElement\\\",1015.0,24.0,\\\"DSO_Incentive_Report_2023-24.pdf_24\\\",\\\".pdf\\\",38.0,83332.0,\\\"2024\\\",0.0022015206],[\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf\\\",\\\"Setting ex ante allowances .............................................................. 32 Introduction ....................................................................................... 32 Ex ante allowances .............................................................................. 32 Technically assessed costs ................................................................... 37 Engineering Justification Paper review .................................................... 38 TIM ................................................................................................... 42 BPI Stage 3 ........................................................................................ 42 BPI Stage 4 ........................................................................................ 43 4. Adjusting ex ante allowances for uncertainty .................................. 44 Introduction ....................................................................................... 44 Bespoke UM Proposals ......................................................................... 44 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf_2\\\",\\\".pdf\\\",71.0,116133.0,\\\"2022\\\",0.0021417236],[\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf\\\",\\\"Setting ex ante allowances .............................................................. 28 Introduction ....................................................................................... 28 Ex ante allowances .............................................................................. 28 Technically assessed costs ................................................................... 30 Engineering Justification Paper review .................................................... 31 TIM ................................................................................................... 33 BPI Stage 3 ........................................................................................ 33 BPI Stage 4 ........................................................................................ 33 4. Adjusting ex ante allowances for uncertainty .................................. 35 Introduction ....................................................................................... 35 Bespoke UM Proposals ......................................................................... 35 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf_2\\\",\\\".pdf\\\",53.0,82947.0,\\\"2022\\\",0.0021324502],[\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf\\\",\\\"measured in previous iterations relative to the defined RIIO-1 counterfactual and\\\\n\\\\nbased on a transparent set of assumptions which were set out in the previous IAs.\\\\n\\\\nThis final IA updates that analysis presented in the DD IA to reflect the actual\\\\n\\\\nvalues and approaches as set out in our Final Determinations.\\\\n\\\\n2.3 Over the five-year RIIO-ED2 period, we expect our Final Determinations to deliver\\\\n\\\\nnet benefits to consumers of up to £428m, relative to the counterfactual. The\\\\n\\\\ndominant quantified effect arises from a resetting (lowering) of the cost of equity\\\\n\\\\nto current market rates, which drives a large transfer from investors to\\\\n\\\\nconsumers, compared to the counterfactual. The £428m consumer benefits value\\\\n\\\\nis lower compared to that assessed in the DD IA given changes in market\\\\n\\\\nconditions (higher interest rates) that influence the cost of capital and higher totex\\\\n\\\\nallowances proposed for each of the companies.\\\\n\\\\n2.4\\\\n\\\\nThere are different ways consumer benefits can be calculated. In this IA, the\\\",\\\"CompositeElement\\\",1005.0,7.0,\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf_7\\\",\\\".pdf\\\",62.0,125232.0,\\\"2022\\\",0.0021262604]]}\"}</uc_function_result>\n\nIs 'Cost Benefit Analysis' what you meant by CBA? (Yes/No)"
#                 },
#                 {
#                     "role": "user",
#                     "content": "I don't know what you are asking"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "I was asking if you meant \"Cost Benefit Analysis\" when you used the acronym \"CBA\". But since you're not sure, let me clarify. I found that \"CBA\" stands for \"Cost Benefit Analysis\" in the context of energy regulation and policies. \n\nTo answer your original question, \"how is CBA applied?\", I found some relevant information in the documents. According to the document \"RIIO-ED2 Final Determinations Core Methodology.pdf\", a cost-benefit analysis is required for certain projects, and network companies are expected to publish benefit statements, including cost-benefit calculations, alongside project progress information. \n\nAdditionally, the document \"DSO_Incentive_Report_2023-24.pdf\" mentions that cost-benefit analysis or other actions should be highlighted in submissions, and that evidence should be provided to demonstrate the full context of decisions and performance figures.\n\nPlease let me know if you'd like me to elaborate or provide more information."
#                 },
#                 {
#                     "role": "user",
#                     "content": "it's great"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "I'm glad I could provide a helpful answer. If you have any more questions or need further clarification on anything, feel free to ask!"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Can you explain what CBA means in the context of the DSO Incentive Report?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "To clarify the meaning of CBA in the context of the DSO Incentive Report\n\n<uc_function_call>{\"id\":\"KT4MW18hIk3u5aLIvh54\",\"name\":\"kyra_wulffert.poc_doc_management.lookup_glossary\",\"arguments\":\"{\\\"input_acronym\\\":\\\"CBA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"KT4MW18hIk3u5aLIvh54\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"definition\\\",\\\"certainty\\\"],\\\"rows\\\":[[\\\"Cost Benefit Analysis\\\",100]]}\"}</uc_function_result>\n\nIn the context of the DSO Incentive Report, CBA refers to \"Cost Benefit Analysis\". \n\nAccording to the document \"DSO_Incentive_Report_2023-24.pdf\", a cost-benefit analysis is expected to be provided as evidence to demonstrate the impact and results of discussed activities. This means that the report is encouraging the use of cost-benefit analysis to evaluate the effectiveness of certain actions or decisions, and to provide a clear understanding of the costs and benefits associated with them."
#                 },
#                 {
#                     "role": "user",
#                     "content": "Thanks, what is the LAEP used for in the DSO Incentive Report?"
#                 }
#             ]
#         },
#         "expected_response": None
#     },
#     {
#         "request": {
#             "messages": [
#                 {
#                     "role": "system",
#                     "content": "You are a highly knowledgeable assistant specializing in answering questions about energy regulation and policies. You have access to a knowledge base of official documents. Your goal is to provide accurate, concise, and helpful answers based strictly on the information in these documents. You must not hallucinate or invent any information. If the answer cannot be found in the documents, politely inform the user. If you do not know the answer to a question, you truthfully say you do not know.\n\nWhen the user asks a question, follow these steps:\n\n1. **Check for Acronyms**:\n   - If the user's input contains an acronym (e.g., CBA, LAEP):\n     - Use the **glossary_lookup** tool to fetch the definition of the acronym from the glossary.\n     - After retrieving the definition, ask the user: \"Is '{definition}' what you meant by {acronym}? (Yes/No)\".\n       - The definition should be **explicitly provided** in the confirmation question. For example: \"Is 'Cost-Benefit Analysis' what you meant by CBA? (Yes/No)\".\n     - If the user confirms with \"Yes\":\n       - Proceed by using the **vector search** function to retrieve relevant context from the RAG system, **enhancing the context with the acronym's definition**.\n       - Craft your answer based on the retrieved context and the acronym's definition, ensuring that you include the **file name** and other relevant metadata in the response.\n     - If the user does **not** confirm the definition with \"Yes\":\n       - Politely ask the user for more clarification by saying: \"Could you please provide more context or clarify what you mean by {acronym}?\" and do **not** proceed to context retrieval until you receive further clarification.\n\n2. **If No Acronym is Present**:\n   - If the user's input **does not contain an acronym**, proceed directly to **vector search** to retrieve the relevant context based on the question.\n   - Craft your answer based on the retrieved context, ensuring you include the **file name** and other relevant metadata.\n\n3. **Contextual Answering**:\n   - After the acronym is validated (or if no acronym is present), use the retrieved context from the vector search to answer the question directly.\n   - Include the **file_name** (or any other relevant metadata) from the context to show where the information was retrieved from, for example, \"The information was retrieved from the document: {file_name}\".\n   - Do not include any unnecessary explanations about the context or the process.\n\nHere is the history of the current conversation you are having with your user: {chat_history}. And here is some context which may or may not help you answer the following question: {context}. Answer directly, do not repeat the question, do not start with something like: \"the answer to the question\", do not add \"AI\" in front of your answer, do not say: \"here is the answer\", do not mention the context or the question. Based on this context, answer this question: {question}.\n"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Hi"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "Welcome! I'm here to help with any questions you have about energy regulation and policies. Please go ahead and ask your question, and I'll do my best to provide a helpful and accurate answer based on the information available in the official documents."
#                 },
#                 {
#                     "role": "user",
#                     "content": "how is cba applied?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "The user's input contains an acronym 'CBA' which needs to be defined before proceeding with the question. The definition of 'CBA' will help in understanding the context of the question and provide a more accurate answer.\n\n<uc_function_call>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"name\":\"kyra_wulffert.poc_doc_management.lookup_glossary\",\"arguments\":\"{\\\"input_acronym\\\":\\\"CBA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"definition\\\",\\\"certainty\\\"],\\\"rows\\\":[[\\\"Cost Benefit Analysis\\\",100]]}\"}</uc_function_result>\n\nTo find out how Cost Benefit Analysis (CBA) is applied, I need to search the documentation for relevant information on this topic.\n\n<uc_function_call>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"name\":\"kyra_wulffert.poc_doc_management.search_documentation\",\"arguments\":\"{\\\"topic\\\":\\\"Cost Benefit Analysis application\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"uuid\\\",\\\"content\\\",\\\"category\\\",\\\"char_length\\\",\\\"chunk_num\\\",\\\"file_name\\\",\\\"file_extension\\\",\\\"num_pages\\\",\\\"length\\\",\\\"year\\\",\\\"score\\\"],\\\"rows\\\":[[\\\"RIIO-ED2 Final Determinations Core Methodology.pdf\\\",\\\"required in this area and that consistency in how benefits are measured across network companies and sectors can improve. We plan to work with network companies on this during RIIO-ED2.\\\\n\\\\n3.118 Furthermore, we will consult on adding a requirement to NIA governance for network companies to publish benefit statements including cost- benefit calculations alongside project progress information, to increase transparency.\\\\n\\\\nCarry-over RIIO-1 Network Innovation Allowance\\\\n\\\\nPurpose\\\\n\\\\nTo prevent the abrupt ending of some RIIO-1 NIA\\\\n\\\\nprojects, and potential reductions in innovation activity.\\\\n\\\\nBenefits\\\\n\\\\nTo enable project delivery and completion, and resulting\\\\n\\\\nlessons learned to be shared across industry, with\\\\n\\\\npotential consumer benefits.\\\\n\\\\nFinal Determination summary\\\\n\\\\n3.119 The table below provides a summary of our Final Determination position.\\\\n\\\\n43\\\\n\\\\nDecision – RIIO-ED2 Final Determinations Core Methodology Document\\\\n\\\\nParameter\\\\n\\\\nFinal Determination\\\\n\\\\nDraft Determination\\\\n\\\\nEnd date for spending RIIO- ED1 NIA funds\\\",\\\"CompositeElement\\\",1010.0,84.0,\\\"RIIO-ED2 Final Determinations Core Methodology.pdf_84\\\",\\\".pdf\\\",364.0,857803.0,\\\"2022\\\",0.0022498108],[\\\"DSO_Incentive_Report_2023-24.pdf\\\",\\\"cost benefit analysis or other actions being highlighted in submissions. The\\\\n\\\\nevidence provided should refer as explicitly as possible to the submission year\\\\n\\\\nwith clear timelines whenever possible. Given the varying factors influencing\\\\n\\\\nstrategic decision-making, it is essential that submissions demonstrate the full\\\\n\\\\n15\\\\n\\\\nReport\\\\n\\\\ncontext of decisions and performance figures for the Panel to make informed\\\\n\\\\njudgement.\\\\n\\\\n4.17\\\\n\\\\nFor example, there were many different approaches to DSO governance\\\\n\\\\ndemonstrated across DNO submissions. However, the evidence sometimes didn’t\\\\n\\\\nfully justify why an approach was chosen over other potential options and why it\\\\n\\\\nrepresented the most value for customers and stakeholders.\\\\n\\\\n4.18\\\\n\\\\nSimilarly, more substantive evidence is expected regarding the impact and\\\\n\\\\nresults of discussed activities. For example, the Panel noted that having an\\\\n\\\\nIndependent Panel is not beneficial by default, so DNOs are encouraged to\\\\n\\\\ndemonstrate the impact the Independent Panel has had, how this has\\\",\\\"CompositeElement\\\",1015.0,24.0,\\\"DSO_Incentive_Report_2023-24.pdf_24\\\",\\\".pdf\\\",38.0,83332.0,\\\"2024\\\",0.0022015206],[\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf\\\",\\\"Setting ex ante allowances .............................................................. 32 Introduction ....................................................................................... 32 Ex ante allowances .............................................................................. 32 Technically assessed costs ................................................................... 37 Engineering Justification Paper review .................................................... 38 TIM ................................................................................................... 42 BPI Stage 3 ........................................................................................ 42 BPI Stage 4 ........................................................................................ 43 4. Adjusting ex ante allowances for uncertainty .................................. 44 Introduction ....................................................................................... 44 Bespoke UM Proposals ......................................................................... 44 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf_2\\\",\\\".pdf\\\",71.0,116133.0,\\\"2022\\\",0.0021417236],[\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf\\\",\\\"Setting ex ante allowances .............................................................. 28 Introduction ....................................................................................... 28 Ex ante allowances .............................................................................. 28 Technically assessed costs ................................................................... 30 Engineering Justification Paper review .................................................... 31 TIM ................................................................................................... 33 BPI Stage 3 ........................................................................................ 33 BPI Stage 4 ........................................................................................ 33 4. Adjusting ex ante allowances for uncertainty .................................. 35 Introduction ....................................................................................... 35 Bespoke UM Proposals ......................................................................... 35 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf_2\\\",\\\".pdf\\\",53.0,82947.0,\\\"2022\\\",0.0021324502],[\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf\\\",\\\"measured in previous iterations relative to the defined RIIO-1 counterfactual and\\\\n\\\\nbased on a transparent set of assumptions which were set out in the previous IAs.\\\\n\\\\nThis final IA updates that analysis presented in the DD IA to reflect the actual\\\\n\\\\nvalues and approaches as set out in our Final Determinations.\\\\n\\\\n2.3 Over the five-year RIIO-ED2 period, we expect our Final Determinations to deliver\\\\n\\\\nnet benefits to consumers of up to £428m, relative to the counterfactual. The\\\\n\\\\ndominant quantified effect arises from a resetting (lowering) of the cost of equity\\\\n\\\\nto current market rates, which drives a large transfer from investors to\\\\n\\\\nconsumers, compared to the counterfactual. The £428m consumer benefits value\\\\n\\\\nis lower compared to that assessed in the DD IA given changes in market\\\\n\\\\nconditions (higher interest rates) that influence the cost of capital and higher totex\\\\n\\\\nallowances proposed for each of the companies.\\\\n\\\\n2.4\\\\n\\\\nThere are different ways consumer benefits can be calculated. In this IA, the\\\",\\\"CompositeElement\\\",1005.0,7.0,\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf_7\\\",\\\".pdf\\\",62.0,125232.0,\\\"2022\\\",0.0021262604]]}\"}</uc_function_result>\n\nIs 'Cost Benefit Analysis' what you meant by CBA? (Yes/No)"
#                 },
#                 {
#                     "role": "user",
#                     "content": "I don't know what you are asking"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "I was asking if you meant \"Cost Benefit Analysis\" when you used the acronym \"CBA\". But since you're not sure, let me clarify. I found that \"CBA\" stands for \"Cost Benefit Analysis\" in the context of energy regulation and policies. \n\nTo answer your original question, \"how is CBA applied?\", I found some relevant information in the documents. According to the document \"RIIO-ED2 Final Determinations Core Methodology.pdf\", a cost-benefit analysis is required for certain projects, and network companies are expected to publish benefit statements, including cost-benefit calculations, alongside project progress information. \n\nAdditionally, the document \"DSO_Incentive_Report_2023-24.pdf\" mentions that cost-benefit analysis or other actions should be highlighted in submissions, and that evidence should be provided to demonstrate the full context of decisions and performance figures.\n\nPlease let me know if you'd like me to elaborate or provide more information."
#                 },
#                 {
#                     "role": "user",
#                     "content": "it's great"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "I'm glad I could provide a helpful answer. If you have any more questions or need further clarification on anything, feel free to ask!"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Can you explain what CBA means in the context of the DSO Incentive Report?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "To clarify the meaning of CBA in the context of the DSO Incentive Report\n\n<uc_function_call>{\"id\":\"KT4MW18hIk3u5aLIvh54\",\"name\":\"kyra_wulffert.poc_doc_management.lookup_glossary\",\"arguments\":\"{\\\"input_acronym\\\":\\\"CBA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"KT4MW18hIk3u5aLIvh54\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"definition\\\",\\\"certainty\\\"],\\\"rows\\\":[[\\\"Cost Benefit Analysis\\\",100]]}\"}</uc_function_result>\n\nIn the context of the DSO Incentive Report, CBA refers to \"Cost Benefit Analysis\". \n\nAccording to the document \"DSO_Incentive_Report_2023-24.pdf\", a cost-benefit analysis is expected to be provided as evidence to demonstrate the impact and results of discussed activities. This means that the report is encouraging the use of cost-benefit analysis to evaluate the effectiveness of certain actions or decisions, and to provide a clear understanding of the costs and benefits associated with them."
#                 },
#                 {
#                     "role": "user",
#                     "content": "Thanks, what is the LAEP used for in the DSO Incentive Report?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "To find the definition of the acronym LAEP in the context of the DSO Incentive Report\n\n<uc_function_call>{\"id\":\"DCT3jCfVAJ15S3Mv1ABR\",\"name\":\"kyra_wulffert.poc_doc_management.lookup_glossary\",\"arguments\":\"{\\\"input_acronym\\\":\\\"LAE\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"DCT3jCfVAJ15S3Mv1ABR\",\"content\":\"<Empty output>\"}</uc_function_result>\n\nI am calling the function to search for documentation related to LAEP, as it was mentioned in the context of the DSO Incentive Report, and I want to provide more information on what it is used for.\n\n<uc_function_call>{\"id\":\"TUQBZ9oHqlH4o4298fCL\",\"name\":\"kyra_wulffert.poc_doc_management.search_documentation\",\"arguments\":\"{\\\"topic\\\":\\\"LAE\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"TUQBZ9oHqlH4o4298fCL\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"uuid\\\",\\\"content\\\",\\\"category\\\",\\\"char_length\\\",\\\"chunk_num\\\",\\\"file_name\\\",\\\"file_extension\\\",\\\"num_pages\\\",\\\"length\\\",\\\"year\\\",\\\"score\\\"],\\\"rows\\\":[[\\\"SSEN-DFES-2023-Southern-England.pdf\\\",\\\"One of the leading LAES developers in the UK is Highview Power, which is developing\\\\n\\\\ntrial and pre-commercial plants, including one in Greater Manchester.83F\\\\n\\\\nlvii\\\\n\\\\nSSEN Distribution Future Energy Scenarios 2023 – Southern England\\\\n\\\\n151\\\\n\\\\nNo LAES plants are yet operational in the Southern England licence area. There are\\\\n\\\\nalso no known pipeline projects with connection offers to connect to the distribution\\\\n\\\\nnetwork in the licence area.\\\\n\\\\nHowever, through direct consultation with representatives from Highview Power to\\\\n\\\\ninform previous DFES analysis, some LAES business models are being considered,\\\\n\\\\nincluding:\\\\n\\\\no Co-location with renewable energy generation technology (as a source of low-\\\\n\\\\ncost, low-carbon input electricity).\\\\n\\\\no Co-location with large-scale data centres that require a significant cooling load\\\\n\\\\n(this aligns with the cryogenic aspect of the LAES storage cycle).\\\\n\\\\no Provision of flexibility services via future grid balancing contracts, such as those\\\\n\\\\nissued by National Grid ESO’s Stability Pathfinder.84F\\\",\\\"CompositeElement\\\",1025.0,239.0,\\\"SSEN-DFES-2023-Southern-England.pdf_239\\\",\\\".pdf\\\",215.0,348894.0,\\\"2024\\\",0.0026453505],[\\\"SSEN-DFES-2023-North-of-Scotland.pdf\\\",\\\"for local authorities to produce LAEPs. Of those local authorities who responded to the local\\\\n\\\\nenergy strategy survey (see page 30), four local authorities across SSEN’s two licence areas\\\\n\\\\nhave LAEPs already in place and a further nine local authorities are in the process of developing a LAEP 15. DFES analysis seeks to make use of the disclosures in the LAEPs,\\\\n\\\\nincluding specific decarbonisation targets, technology deployment ambitions and regional\\\\n\\\\nzoning.\\\\n\\\\nOver the past three years, SSEN has developed the Local Energy Net Zero Accelerator 16\\\\n\\\\n(LENZA) tool to assist local authorities in developing LAEPs. LENZA is a geospatial software\\\\n\\\\nplatform, based on Advanced Infrastructure Technology Ltd’s LAEP+ tool. It provides network\\\\n\\\\nconstraint data to inform local authority planning decisions for the development of new\\\\n\\\\n14 https://www.ssen.co.uk/globalassets/about-us/dso/dso-action-plan/ssen-dso-strategy-2023.pdf 15 These figures refer only to the responses received by Regen from local authorities to the Local Energy Strategy Survey as part of the DFES 2023 analysis. 16 https://www.ssen.co.uk/our-services/tools-and-maps/lenza/\\\",\\\"CompositeElement\\\",1139.0,28.0,\\\"SSEN-DFES-2023-North-of-Scotland.pdf_28\\\",\\\".pdf\\\",230.0,385128.0,\\\"2024\\\",0.0024981967],[\\\"SSEN-DFES-2023-Southern-England.pdf\\\",\\\"near-term.\\\\n\\\\nPrevious engagement with\\\\n\\\\nHighview Power highlighted\\\\n\\\\nthat the location of LAES plants\\\\n\\\\nin the Southern England licence\\\\n\\\\nLiquid Air Energy\\\\n\\\\nStorage (LAES)\\\\n\\\\nHighview Power\\\\n\\\\narea could be based on a\\\\n\\\\npotential to co-locate with\\\\n\\\\nlarge-scale renewable energy\\\\n\\\\ngeneration sites or large-scale\\\\n\\\\ndata centres, due to cooling\\\\n\\\\ndemand.\\\\n\\\\nTable 1 Summary of sector specific engagement undertaken to inform DFES 2023\\\\n\\\\nSSEN Distribution Future Energy Scenarios 2023 – Southern England\\\\n\\\\n29\\\\n\\\\nFurther detail of the sector- and technology-specific engagement undertaken, the feedback\\\\n\\\\nreceived and how it was applied to the DFES modelling can be found in each of the technology\\\\n\\\\nsummary chapters included in this report. In addition, the Regen project team have continued\\\\n\\\\nto engage with the National Grid ESO FES team both as part of the launch of FES 2023 and\\\\n\\\\nthroughout the ongoing analysis, to discuss and share modelling assumptions and market\\\\n\\\\nintelligence.\\\\n\\\\nSSEN Distribution Future Energy Scenarios 2023 – Southern England\\\",\\\"CompositeElement\\\",1027.0,44.0,\\\"SSEN-DFES-2023-Southern-England.pdf_44\\\",\\\".pdf\\\",215.0,348894.0,\\\"2024\\\",0.0024101227],[\\\"SSEN-DFES-2023-Southern-England.pdf\\\",\\\"have LAEPs already in place and a further nine local authorities are in the process of 15. DFES analysis seeks to make use of the disclosures in the LAEPs, including specific decarbonisation targets, technology deployment ambitions and regional\\\\n\\\\ndeveloping a LAEP 14F\\\\n\\\\nzoning.\\\\n\\\\nOver the past three years, SSEN has developed the Local Energy Net Zero Accelerator 15F\\\\n\\\\n(LENZA) tool to assist local authorities in developing LAEPs. LENZA is a geospatial software\\\\n\\\\n14 https://www.ssen.co.uk/globalassets/about-us/dso/dso-action-plan/ssen-dso-strategy-2023.pdf 15 These figures refer only to the responses received by Regen from local authorities to the Local Energy Strategy Survey as part of the DFES 2023 analysis. 16 https://www.ssen.co.uk/our-services/tools-and-maps/lenza/\\\\n\\\\nSSEN Distribution Future Energy Scenarios 2023 – Southern England\\\\n\\\\n16\\\\n\\\\n16\\\\n\\\\nplatform, based on Advanced Infrastructure Technology Ltd’s LAEP+ tool. It provides network\\\\n\\\\nconstraint data to inform local authority planning decisions for the development of new\\\",\\\"CompositeElement\\\",1030.0,27.0,\\\"SSEN-DFES-2023-Southern-England.pdf_27\\\",\\\".pdf\\\",215.0,348894.0,\\\"2024\\\",0.002409619],[\\\"SSEN-DFES-2023-North-of-Scotland.pdf\\\",\\\"are also no known pipeline projects with connection offers to connect to the\\\\n\\\\ndistribution network in the licence area.\\\\n\\\\nHowever, through direct consultation with representatives from Highview Power to\\\\n\\\\ninform previous DFES analysis, some LAES business models are being considered,\\\\n\\\\nincluding:\\\\n\\\\no Co-location with renewable energy generation technology (as a source of low-\\\\n\\\\ncost, low-carbon input electricity).\\\\n\\\\no Co-location with large-scale data centres that require a significant cooling load\\\\n\\\\n(this aligns with the cryogenic aspect of the LAES storage cycle).\\\\n\\\\no Provision of flexibility services via future grid balancing contracts, such as those\\\\n\\\\nissued by National Grid ESO’s Stability Pathfinder.lxxxvi\\\\n\\\\nAs a result of this feedback and the significant capacity of distributed renewable\\\\n\\\\nenergy generation in the North of Scotland licence area (onshore wind and large-scale\\\\n\\\\nsolar PV), both the DFES 2022 and DFES 2023 has modelled 20 MW of new distributed\\\\n\\\\nLAES capacity to come online by 2035 and 40 MW by 2050, under Leading the Way.\\\",\\\"CompositeElement\\\",1045.0,263.0,\\\"SSEN-DFES-2023-North-of-Scotland.pdf_263\\\",\\\".pdf\\\",230.0,385128.0,\\\"2024\\\",0.002394338]]}\"}</uc_function_result>\n\nIn the context of the DSO Incentive Report, LAEP stands for Local Authority Energy Plan."
#                 },
#                 {
#                     "role": "user",
#                     "content": "Thanks, what is the LAEP used for in the DSO Incentive Report?"
#                 }
#             ]
#         },
#         "expected_response": None
#     },
#     {
#         "request": {
#             "messages": [
#                 {
#                     "role": "system",
#                     "content": "You are a highly knowledgeable assistant specializing in answering questions about energy regulation and policies. You have access to a knowledge base of official documents. Your goal is to provide accurate, concise, and helpful answers based strictly on the information in these documents. You must not hallucinate or invent any information. If the answer cannot be found in the documents, politely inform the user. If you do not know the answer to a question, you truthfully say you do not know.\n\nWhen the user asks a question, follow these steps:\n\n1. **Check for Acronyms**:\n   - If the user's input contains an acronym (e.g., CBA, LAEP):\n     - Use the **glossary_lookup** tool to fetch the definition of the acronym from the glossary.\n     - After retrieving the definition, ask the user: \"Is '{definition}' what you meant by {acronym}? (Yes/No)\".\n       - The definition should be **explicitly provided** in the confirmation question. For example: \"Is 'Cost-Benefit Analysis' what you meant by CBA? (Yes/No)\".\n     - If the user confirms with \"Yes\":\n       - Proceed by using the **vector search** function to retrieve relevant context from the RAG system, **enhancing the context with the acronym's definition**.\n       - Craft your answer based on the retrieved context and the acronym's definition, ensuring that you include the **file name** and other relevant metadata in the response.\n     - If the user does **not** confirm the definition with \"Yes\":\n       - Politely ask the user for more clarification by saying: \"Could you please provide more context or clarify what you mean by {acronym}?\" and do **not** proceed to context retrieval until you receive further clarification.\n\n2. **If No Acronym is Present**:\n   - If the user's input **does not contain an acronym**, proceed directly to **vector search** to retrieve the relevant context based on the question.\n   - Craft your answer based on the retrieved context, ensuring you include the **file name** and other relevant metadata.\n\n3. **Contextual Answering**:\n   - After the acronym is validated (or if no acronym is present), use the retrieved context from the vector search to answer the question directly.\n   - Include the **file_name** (or any other relevant metadata) from the context to show where the information was retrieved from, for example, \"The information was retrieved from the document: {file_name}\".\n   - Do not include any unnecessary explanations about the context or the process.\n\nHere is the history of the current conversation you are having with your user: {chat_history}. And here is some context which may or may not help you answer the following question: {context}. Answer directly, do not repeat the question, do not start with something like: \"the answer to the question\", do not add \"AI\" in front of your answer, do not say: \"here is the answer\", do not mention the context or the question. Based on this context, answer this question: {question}.\n"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Hi"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "Welcome! I'm here to help with any questions you have about energy regulation and policies. Please go ahead and ask your question, and I'll do my best to provide a helpful and accurate answer based on the information available in the official documents."
#                 },
#                 {
#                     "role": "user",
#                     "content": "how is cba applied?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "The user's input contains an acronym 'CBA' which needs to be defined before proceeding with the question. The definition of 'CBA' will help in understanding the context of the question and provide a more accurate answer.\n\n<uc_function_call>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"name\":\"kyra_wulffert.poc_doc_management.lookup_glossary\",\"arguments\":\"{\\\"input_acronym\\\":\\\"CBA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"nwmdv9CE7MG1TnKJ8lyN\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"definition\\\",\\\"certainty\\\"],\\\"rows\\\":[[\\\"Cost Benefit Analysis\\\",100]]}\"}</uc_function_result>\n\nTo find out how Cost Benefit Analysis (CBA) is applied, I need to search the documentation for relevant information on this topic.\n\n<uc_function_call>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"name\":\"kyra_wulffert.poc_doc_management.search_documentation\",\"arguments\":\"{\\\"topic\\\":\\\"Cost Benefit Analysis application\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"xdZhkXHviil1uJBo9zCX\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"uuid\\\",\\\"content\\\",\\\"category\\\",\\\"char_length\\\",\\\"chunk_num\\\",\\\"file_name\\\",\\\"file_extension\\\",\\\"num_pages\\\",\\\"length\\\",\\\"year\\\",\\\"score\\\"],\\\"rows\\\":[[\\\"RIIO-ED2 Final Determinations Core Methodology.pdf\\\",\\\"required in this area and that consistency in how benefits are measured across network companies and sectors can improve. We plan to work with network companies on this during RIIO-ED2.\\\\n\\\\n3.118 Furthermore, we will consult on adding a requirement to NIA governance for network companies to publish benefit statements including cost- benefit calculations alongside project progress information, to increase transparency.\\\\n\\\\nCarry-over RIIO-1 Network Innovation Allowance\\\\n\\\\nPurpose\\\\n\\\\nTo prevent the abrupt ending of some RIIO-1 NIA\\\\n\\\\nprojects, and potential reductions in innovation activity.\\\\n\\\\nBenefits\\\\n\\\\nTo enable project delivery and completion, and resulting\\\\n\\\\nlessons learned to be shared across industry, with\\\\n\\\\npotential consumer benefits.\\\\n\\\\nFinal Determination summary\\\\n\\\\n3.119 The table below provides a summary of our Final Determination position.\\\\n\\\\n43\\\\n\\\\nDecision – RIIO-ED2 Final Determinations Core Methodology Document\\\\n\\\\nParameter\\\\n\\\\nFinal Determination\\\\n\\\\nDraft Determination\\\\n\\\\nEnd date for spending RIIO- ED1 NIA funds\\\",\\\"CompositeElement\\\",1010.0,84.0,\\\"RIIO-ED2 Final Determinations Core Methodology.pdf_84\\\",\\\".pdf\\\",364.0,857803.0,\\\"2022\\\",0.0022498108],[\\\"DSO_Incentive_Report_2023-24.pdf\\\",\\\"cost benefit analysis or other actions being highlighted in submissions. The\\\\n\\\\nevidence provided should refer as explicitly as possible to the submission year\\\\n\\\\nwith clear timelines whenever possible. Given the varying factors influencing\\\\n\\\\nstrategic decision-making, it is essential that submissions demonstrate the full\\\\n\\\\n15\\\\n\\\\nReport\\\\n\\\\ncontext of decisions and performance figures for the Panel to make informed\\\\n\\\\njudgement.\\\\n\\\\n4.17\\\\n\\\\nFor example, there were many different approaches to DSO governance\\\\n\\\\ndemonstrated across DNO submissions. However, the evidence sometimes didn’t\\\\n\\\\nfully justify why an approach was chosen over other potential options and why it\\\\n\\\\nrepresented the most value for customers and stakeholders.\\\\n\\\\n4.18\\\\n\\\\nSimilarly, more substantive evidence is expected regarding the impact and\\\\n\\\\nresults of discussed activities. For example, the Panel noted that having an\\\\n\\\\nIndependent Panel is not beneficial by default, so DNOs are encouraged to\\\\n\\\\ndemonstrate the impact the Independent Panel has had, how this has\\\",\\\"CompositeElement\\\",1015.0,24.0,\\\"DSO_Incentive_Report_2023-24.pdf_24\\\",\\\".pdf\\\",38.0,83332.0,\\\"2024\\\",0.0022015206],[\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf\\\",\\\"Setting ex ante allowances .............................................................. 32 Introduction ....................................................................................... 32 Ex ante allowances .............................................................................. 32 Technically assessed costs ................................................................... 37 Engineering Justification Paper review .................................................... 38 TIM ................................................................................................... 42 BPI Stage 3 ........................................................................................ 42 BPI Stage 4 ........................................................................................ 43 4. Adjusting ex ante allowances for uncertainty .................................. 44 Introduction ....................................................................................... 44 Bespoke UM Proposals ......................................................................... 44 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations SSEN Annex_.pdf_2\\\",\\\".pdf\\\",71.0,116133.0,\\\"2022\\\",0.0021417236],[\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf\\\",\\\"Setting ex ante allowances .............................................................. 28 Introduction ....................................................................................... 28 Ex ante allowances .............................................................................. 28 Technically assessed costs ................................................................... 30 Engineering Justification Paper review .................................................... 31 TIM ................................................................................................... 33 BPI Stage 3 ........................................................................................ 33 BPI Stage 4 ........................................................................................ 33 4. Adjusting ex ante allowances for uncertainty .................................. 35 Introduction ....................................................................................... 35 Bespoke UM Proposals ......................................................................... 35 5.\\\",\\\"CompositeElement\\\",1096.0,2.0,\\\"RIIO-ED2 Final Determinations ENWL Annex.pdf_2\\\",\\\".pdf\\\",53.0,82947.0,\\\"2022\\\",0.0021324502],[\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf\\\",\\\"measured in previous iterations relative to the defined RIIO-1 counterfactual and\\\\n\\\\nbased on a transparent set of assumptions which were set out in the previous IAs.\\\\n\\\\nThis final IA updates that analysis presented in the DD IA to reflect the actual\\\\n\\\\nvalues and approaches as set out in our Final Determinations.\\\\n\\\\n2.3 Over the five-year RIIO-ED2 period, we expect our Final Determinations to deliver\\\\n\\\\nnet benefits to consumers of up to £428m, relative to the counterfactual. The\\\\n\\\\ndominant quantified effect arises from a resetting (lowering) of the cost of equity\\\\n\\\\nto current market rates, which drives a large transfer from investors to\\\\n\\\\nconsumers, compared to the counterfactual. The £428m consumer benefits value\\\\n\\\\nis lower compared to that assessed in the DD IA given changes in market\\\\n\\\\nconditions (higher interest rates) that influence the cost of capital and higher totex\\\\n\\\\nallowances proposed for each of the companies.\\\\n\\\\n2.4\\\\n\\\\nThere are different ways consumer benefits can be calculated. In this IA, the\\\",\\\"CompositeElement\\\",1005.0,7.0,\\\"RIIO-ED2 Final Determinations Impact Assessment.pdf_7\\\",\\\".pdf\\\",62.0,125232.0,\\\"2022\\\",0.0021262604]]}\"}</uc_function_result>\n\nIs 'Cost Benefit Analysis' what you meant by CBA? (Yes/No)"
#                 },
#                 {
#                     "role": "user",
#                     "content": "I don't know what you are asking"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "I was asking if you meant \"Cost Benefit Analysis\" when you used the acronym \"CBA\". But since you're not sure, let me clarify. I found that \"CBA\" stands for \"Cost Benefit Analysis\" in the context of energy regulation and policies. \n\nTo answer your original question, \"how is CBA applied?\", I found some relevant information in the documents. According to the document \"RIIO-ED2 Final Determinations Core Methodology.pdf\", a cost-benefit analysis is required for certain projects, and network companies are expected to publish benefit statements, including cost-benefit calculations, alongside project progress information. \n\nAdditionally, the document \"DSO_Incentive_Report_2023-24.pdf\" mentions that cost-benefit analysis or other actions should be highlighted in submissions, and that evidence should be provided to demonstrate the full context of decisions and performance figures.\n\nPlease let me know if you'd like me to elaborate or provide more information."
#                 },
#                 {
#                     "role": "user",
#                     "content": "it's great"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "I'm glad I could provide a helpful answer. If you have any more questions or need further clarification on anything, feel free to ask!"
#                 },
#                 {
#                     "role": "user",
#                     "content": "Can you explain what CBA means in the context of the DSO Incentive Report?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "To clarify the meaning of CBA in the context of the DSO Incentive Report\n\n<uc_function_call>{\"id\":\"KT4MW18hIk3u5aLIvh54\",\"name\":\"kyra_wulffert.poc_doc_management.lookup_glossary\",\"arguments\":\"{\\\"input_acronym\\\":\\\"CBA\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"KT4MW18hIk3u5aLIvh54\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"definition\\\",\\\"certainty\\\"],\\\"rows\\\":[[\\\"Cost Benefit Analysis\\\",100]]}\"}</uc_function_result>\n\nIn the context of the DSO Incentive Report, CBA refers to \"Cost Benefit Analysis\". \n\nAccording to the document \"DSO_Incentive_Report_2023-24.pdf\", a cost-benefit analysis is expected to be provided as evidence to demonstrate the impact and results of discussed activities. This means that the report is encouraging the use of cost-benefit analysis to evaluate the effectiveness of certain actions or decisions, and to provide a clear understanding of the costs and benefits associated with them."
#                 },
#                 {
#                     "role": "user",
#                     "content": "Thanks, what is the LAEP used for in the DSO Incentive Report?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "To find the definition of the acronym LAEP in the context of the DSO Incentive Report\n\n<uc_function_call>{\"id\":\"DCT3jCfVAJ15S3Mv1ABR\",\"name\":\"kyra_wulffert.poc_doc_management.lookup_glossary\",\"arguments\":\"{\\\"input_acronym\\\":\\\"LAE\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"DCT3jCfVAJ15S3Mv1ABR\",\"content\":\"<Empty output>\"}</uc_function_result>\n\nI am calling the function to search for documentation related to LAEP, as it was mentioned in the context of the DSO Incentive Report, and I want to provide more information on what it is used for.\n\n<uc_function_call>{\"id\":\"TUQBZ9oHqlH4o4298fCL\",\"name\":\"kyra_wulffert.poc_doc_management.search_documentation\",\"arguments\":\"{\\\"topic\\\":\\\"LAE\\\"}\"}</uc_function_call>\n\n<uc_function_result>{\"id\":\"TUQBZ9oHqlH4o4298fCL\",\"content\":\"{\\\"is_truncated\\\":false,\\\"columns\\\":[\\\"uuid\\\",\\\"content\\\",\\\"category\\\",\\\"char_length\\\",\\\"chunk_num\\\",\\\"file_name\\\",\\\"file_extension\\\",\\\"num_pages\\\",\\\"length\\\",\\\"year\\\",\\\"score\\\"],\\\"rows\\\":[[\\\"SSEN-DFES-2023-Southern-England.pdf\\\",\\\"One of the leading LAES developers in the UK is Highview Power, which is developing\\\\n\\\\ntrial and pre-commercial plants, including one in Greater Manchester.83F\\\\n\\\\nlvii\\\\n\\\\nSSEN Distribution Future Energy Scenarios 2023 – Southern England\\\\n\\\\n151\\\\n\\\\nNo LAES plants are yet operational in the Southern England licence area. There are\\\\n\\\\nalso no known pipeline projects with connection offers to connect to the distribution\\\\n\\\\nnetwork in the licence area.\\\\n\\\\nHowever, through direct consultation with representatives from Highview Power to\\\\n\\\\ninform previous DFES analysis, some LAES business models are being considered,\\\\n\\\\nincluding:\\\\n\\\\no Co-location with renewable energy generation technology (as a source of low-\\\\n\\\\ncost, low-carbon input electricity).\\\\n\\\\no Co-location with large-scale data centres that require a significant cooling load\\\\n\\\\n(this aligns with the cryogenic aspect of the LAES storage cycle).\\\\n\\\\no Provision of flexibility services via future grid balancing contracts, such as those\\\\n\\\\nissued by National Grid ESO’s Stability Pathfinder.84F\\\",\\\"CompositeElement\\\",1025.0,239.0,\\\"SSEN-DFES-2023-Southern-England.pdf_239\\\",\\\".pdf\\\",215.0,348894.0,\\\"2024\\\",0.0026453505],[\\\"SSEN-DFES-2023-North-of-Scotland.pdf\\\",\\\"for local authorities to produce LAEPs. Of those local authorities who responded to the local\\\\n\\\\nenergy strategy survey (see page 30), four local authorities across SSEN’s two licence areas\\\\n\\\\nhave LAEPs already in place and a further nine local authorities are in the process of developing a LAEP 15. DFES analysis seeks to make use of the disclosures in the LAEPs,\\\\n\\\\nincluding specific decarbonisation targets, technology deployment ambitions and regional\\\\n\\\\nzoning.\\\\n\\\\nOver the past three years, SSEN has developed the Local Energy Net Zero Accelerator 16\\\\n\\\\n(LENZA) tool to assist local authorities in developing LAEPs. LENZA is a geospatial software\\\\n\\\\nplatform, based on Advanced Infrastructure Technology Ltd’s LAEP+ tool. It provides network\\\\n\\\\nconstraint data to inform local authority planning decisions for the development of new\\\\n\\\\n14 https://www.ssen.co.uk/globalassets/about-us/dso/dso-action-plan/ssen-dso-strategy-2023.pdf 15 These figures refer only to the responses received by Regen from local authorities to the Local Energy Strategy Survey as part of the DFES 2023 analysis. 16 https://www.ssen.co.uk/our-services/tools-and-maps/lenza/\\\",\\\"CompositeElement\\\",1139.0,28.0,\\\"SSEN-DFES-2023-North-of-Scotland.pdf_28\\\",\\\".pdf\\\",230.0,385128.0,\\\"2024\\\",0.0024981967],[\\\"SSEN-DFES-2023-Southern-England.pdf\\\",\\\"near-term.\\\\n\\\\nPrevious engagement with\\\\n\\\\nHighview Power highlighted\\\\n\\\\nthat the location of LAES plants\\\\n\\\\nin the Southern England licence\\\\n\\\\nLiquid Air Energy\\\\n\\\\nStorage (LAES)\\\\n\\\\nHighview Power\\\\n\\\\narea could be based on a\\\\n\\\\npotential to co-locate with\\\\n\\\\nlarge-scale renewable energy\\\\n\\\\ngeneration sites or large-scale\\\\n\\\\ndata centres, due to cooling\\\\n\\\\ndemand.\\\\n\\\\nTable 1 Summary of sector specific engagement undertaken to inform DFES 2023\\\\n\\\\nSSEN Distribution Future Energy Scenarios 2023 – Southern England\\\\n\\\\n29\\\\n\\\\nFurther detail of the sector- and technology-specific engagement undertaken, the feedback\\\\n\\\\nreceived and how it was applied to the DFES modelling can be found in each of the technology\\\\n\\\\nsummary chapters included in this report. In addition, the Regen project team have continued\\\\n\\\\nto engage with the National Grid ESO FES team both as part of the launch of FES 2023 and\\\\n\\\\nthroughout the ongoing analysis, to discuss and share modelling assumptions and market\\\\n\\\\nintelligence.\\\\n\\\\nSSEN Distribution Future Energy Scenarios 2023 – Southern England\\\",\\\"CompositeElement\\\",1027.0,44.0,\\\"SSEN-DFES-2023-Southern-England.pdf_44\\\",\\\".pdf\\\",215.0,348894.0,\\\"2024\\\",0.0024101227],[\\\"SSEN-DFES-2023-Southern-England.pdf\\\",\\\"have LAEPs already in place and a further nine local authorities are in the process of 15. DFES analysis seeks to make use of the disclosures in the LAEPs, including specific decarbonisation targets, technology deployment ambitions and regional\\\\n\\\\ndeveloping a LAEP 14F\\\\n\\\\nzoning.\\\\n\\\\nOver the past three years, SSEN has developed the Local Energy Net Zero Accelerator 15F\\\\n\\\\n(LENZA) tool to assist local authorities in developing LAEPs. LENZA is a geospatial software\\\\n\\\\n14 https://www.ssen.co.uk/globalassets/about-us/dso/dso-action-plan/ssen-dso-strategy-2023.pdf 15 These figures refer only to the responses received by Regen from local authorities to the Local Energy Strategy Survey as part of the DFES 2023 analysis. 16 https://www.ssen.co.uk/our-services/tools-and-maps/lenza/\\\\n\\\\nSSEN Distribution Future Energy Scenarios 2023 – Southern England\\\\n\\\\n16\\\\n\\\\n16\\\\n\\\\nplatform, based on Advanced Infrastructure Technology Ltd’s LAEP+ tool. It provides network\\\\n\\\\nconstraint data to inform local authority planning decisions for the development of new\\\",\\\"CompositeElement\\\",1030.0,27.0,\\\"SSEN-DFES-2023-Southern-England.pdf_27\\\",\\\".pdf\\\",215.0,348894.0,\\\"2024\\\",0.002409619],[\\\"SSEN-DFES-2023-North-of-Scotland.pdf\\\",\\\"are also no known pipeline projects with connection offers to connect to the\\\\n\\\\ndistribution network in the licence area.\\\\n\\\\nHowever, through direct consultation with representatives from Highview Power to\\\\n\\\\ninform previous DFES analysis, some LAES business models are being considered,\\\\n\\\\nincluding:\\\\n\\\\no Co-location with renewable energy generation technology (as a source of low-\\\\n\\\\ncost, low-carbon input electricity).\\\\n\\\\no Co-location with large-scale data centres that require a significant cooling load\\\\n\\\\n(this aligns with the cryogenic aspect of the LAES storage cycle).\\\\n\\\\no Provision of flexibility services via future grid balancing contracts, such as those\\\\n\\\\nissued by National Grid ESO’s Stability Pathfinder.lxxxvi\\\\n\\\\nAs a result of this feedback and the significant capacity of distributed renewable\\\\n\\\\nenergy generation in the North of Scotland licence area (onshore wind and large-scale\\\\n\\\\nsolar PV), both the DFES 2022 and DFES 2023 has modelled 20 MW of new distributed\\\\n\\\\nLAES capacity to come online by 2035 and 40 MW by 2050, under Leading the Way.\\\",\\\"CompositeElement\\\",1045.0,263.0,\\\"SSEN-DFES-2023-North-of-Scotland.pdf_263\\\",\\\".pdf\\\",230.0,385128.0,\\\"2024\\\",0.002394338]]}\"}</uc_function_result>\n\nIn the context of the DSO Incentive Report, LAEP stands for Local Authority Energy Plan."
#                 },
#                 {
#                     "role": "user",
#                     "content": "Thanks, what is the LAEP used for in the DSO Incentive Report?"
#                 },
#                 {
#                     "role": "assistant",
#                     "content": "According to the document \"SSEN-DFES-2023-North-of-Scotland.pdf\", the Local Authority Energy Plan (LAEPP) is used to inform local authority planning decisions for the development of new energy projects. The LAEP provides network constraint data, including specific decarbonisation targets, technology deployment ambitions, and regional zoning.\n\nAdditionally, the document mentions that SSEN has developed a tool called the Local Energy Net Zero Accelerator (LENZA) to assist local authorities in developing LAEPs. LENZA is a geospatial software platform that provides network constraint data to inform local authority planning decisions.\n\nThe LAEP is also mentioned in the context of Liquid Air Energy Storage (LAES) business models, where it is noted that LAES plants could be co-located with large-scale renewable energy generation sites or large-scale data centers, due to cooling demand.\n\nOverall, the LAEP is used to support the development of local energy plans and to inform planning decisions for new energy projects, including LAES."
#                 },
#                 {
#                     "role": "user",
#                     "content": "thanks, can you explain me why you searched from LAE in the glossary instead of LAEP?"
#                 }
#             ]
#         },
#         "expected_response": None
#     }
# ]

# eval_dataset = pd.DataFrame(eval_examples)
# display(eval_dataset)

# COMMAND ----------

import mlflow
import pandas as pd

with mlflow.start_run(run_id=logged_agent_info.run_id):
    eval_results = mlflow.evaluate(
        f"runs:/{logged_agent_info.run_id}/agent",  # replace `chain` with artifact_path that you used when calling log_model.
        data=synthetic_eval_data,  # Your evaluation dataset
        model_type="databricks-agent",  # Enable Mosaic AI Agent Evaluation
    )

# Review the evaluation results in the MLFLow UI (see console output), or access them in place:
display(eval_results.tables['eval_results'])

# COMMAND ----------

# MAGIC %md
# MAGIC ## Register the model to Unity Catalog
# MAGIC
# MAGIC Update the `catalog`, `schema`, and `model_name` below to register the MLflow model to Unity Catalog.

# COMMAND ----------

mlflow.set_registry_uri("databricks-uc")

# TODO: define the catalog, schema, and model name for your UC model
catalog = "kyra_wulffert"
schema = "poc_doc_management"
model_name = "agent_with_tools"
UC_MODEL_NAME = f"{catalog}.{schema}.{model_name}"

# register the model to UC
uc_registered_model_info = mlflow.register_model(model_uri=logged_agent_info.model_uri, name=UC_MODEL_NAME)

# COMMAND ----------

# MAGIC %md
# MAGIC ## Deploy the agent

# COMMAND ----------

from databricks import agents

# Deploy the model to the review app and a model serving endpoint
agents.deploy(UC_MODEL_NAME, uc_registered_model_info.version)